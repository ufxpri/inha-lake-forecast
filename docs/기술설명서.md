# 인경호 뷰티 스코어 - 기술 설명서

## 1. 기능 개요 및 개발 목적 (Why / What)

### 1-1. 구현하려는 핵심 기능

**"지금 인경호에 가야 할까?"**라는 질문에 대해 **뷰티 스코어(0~100점)**라는 정량적 지표로 즉각적인 의사결정을 돕는 실시간 날씨 기반 추천 서비스입니다.

**해결하는 문제:**
- 학생들이 인경호의 현재 상태를 직접 가보지 않으면 알 수 없는 문제
- 복잡한 날씨 정보를 해석해야 하는 번거로움
- 사진 촬영이나 데이트 장소로서의 적합성을 판단하기 어려운 문제

**사용자 관점에서의 필요성:**
- 인스타그래머: 무거운 카메라를 들고 나갔는데 날씨가 흐려 허탕 치는 것을 방지
- 캠퍼스 커플: 분위기 좋은 산책 시간을 미리 계획할 수 있음

**MVP 기준:**
- 실시간 뷰티 스코어 계산 및 표시
- 오늘의 최적 시간대 추천
- 이번 주 최적 날짜 추천
- 사용자 사진 업로드 및 AI 검증 기능

### 1-2. 기술 범위(Scope)

**필요 기능 → 실제 구현 상태:**
- ✅ 실시간 기상 데이터 수집 및 뷰티 스코어 계산 (완료)
- ✅ 정적 HTML 컴포넌트 자동 생성 시스템 (완료)
- ✅ HTMX 기반 동적 업데이트 (완료)
- ✅ 이미지 업로드 및 AI 분류 시스템 (완료)
- 🔄 AI 생성 배경 이미지 (프로토타입 수준)
- 🔄 월간 캘린더 예측 기능 (개발 중)

**핵심 기능 우선 개발:** 데이터 수집과 스코어 계산 로직을 우선 완성하고, UI는 정적 파일 서빙으로 단순화하여 안정성과 성능을 확보했습니다.

## 2. 개발 환경 및 사용 기술 (Tools & Stack)

### 2-1. 사용 기술 스택

**Frontend:**
- HTML5, Tailwind CSS, HTMX
- Nginx (정적 파일 서빙)

**Backend:**
- Python FastAPI (이미지 업로드만 담당)
- Apache Airflow 3.1.3 (데이터 파이프라인)

**ML/모델링:**
- Transformers, PyTorch (이미지 분류)
- Pillow (이미지 처리)

**Database/Infra:**
- PostgreSQL (메타데이터 저장)
- Redis (실시간 캐싱)
- Docker & Docker Compose

**기타 툴:**
- GitHub (버전 관리)
- Hypothesis (속성 기반 테스트)

### 2-2. 해당 도구를 선택한 이유

- **Airflow 3.0**: 스케줄링된 작업의 모니터링과 오류 처리가 뛰어나고, 모든 절차가 저장되어 유지보수가 용이함
- **HTMX**: JavaScript 프레임워크 없이도 동적 업데이트가 가능하여 개발 복잡도를 낮춤
- **Nginx + 정적 파일**: 높은 동시 접속자 수를 안정적으로 처리할 수 있고, CDN 연동이 용이함
- **FastAPI**: 비동기 처리가 우수하고 AI 라이브러리와의 호환성이 뛰어남
- **Redis**: 실시간 스코어 캐싱으로 응답 속도 최적화

## 3. 핵심 구현 코드 & 구조 설명 (How)

### 3-1. 디렉토리 구조

```
/
├── app/                    # FastAPI 애플리케이션
│   ├── main.py            # 이미지 업로드 API
│   ├── image_processing.py # AI 이미지 분류
│   └── database.py        # DB 연결 관리
├── airflow/
│   └── dags/              # 데이터 파이프라인
│       ├── weather_etl_dag.py     # 날씨 데이터 수집 및 스코어 계산
│       └── ai_image_dag.py        # AI 이미지 생성
├── nginx/
│   ├── nginx.conf         # 리버스 프록시 설정
│   └── html/              # 정적 웹 페이지
│       ├── index.html     # 메인 페이지
│       └── components/    # HTMX 컴포넌트들
└── docker-compose.yaml    # 전체 서비스 오케스트레이션
```

### 3-2. 핵심 코드 (뷰티 스코어 계산 알고리즘)

```python
def calculate_beauty_score(**context) -> Dict[str, Any]:
    """
    뷰티 스코어 계산 알고리즘
    - 날씨 상태: 40% 가중치
    - 기온 쾌적도: 30% 가중치  
    - 대기질: 20% 가중치
    - 시간대 보정: 10% 가중치
    """
    # 1. 날씨 상태 점수 (40점 만점)
    weather_scores = {
        'clear': 40,        # 맑음
        'partly_cloudy': 35, # 구름 조금
        'cloudy': 25,       # 흐림
        'rain': 5,          # 비
        'snow': 10          # 눈
    }
    weather_score = weather_scores.get(weather_condition, 20)
    
    # 2. 기온 쾌적도 점수 (30점 만점)
    # 최적 온도: 15-25°C
    if 15 <= temperature <= 25:
        temp_score = 30
    elif 10 <= temperature < 15 or 25 < temperature <= 30:
        temp_score = 25
    else:
        temp_score = 5
    
    # 3. 대기질 점수 (20점 만점)
    if aqi <= 50:      # 좋음
        air_score = 20
    elif aqi <= 100:   # 보통
        air_score = 15
    else:              # 나쁨
        air_score = 5
    
    # 4. 시간대 보정 (10점 만점)
    current_hour = datetime.now().hour
    if 6 <= current_hour < 9 or 17 <= current_hour < 20:  # 골든아워
        time_score = 10
    else:
        time_score = 5
    
    # 5. 보너스/페널티 적용
    final_score = weather_score + temp_score + air_score + time_score
    
    # 골든아워 보너스 (+10점)
    if 17.5 <= current_hour + (datetime.now().minute / 60) <= 19:
        final_score += 10
    
    # 강수 확률 페널티 (-50점)
    if precipitation_prob > 60:
        final_score -= 50
    
    # 0-100 범위로 제한
    final_score = max(0, min(100, int(final_score)))
    
    return final_score
```

### 3-3. 코드 설명

**뷰티 스코어 계산 로직:**
1. **입력**: 기상청 API에서 받은 날씨 데이터 (온도, 날씨상태, 강수확률)와 환경공단 API의 대기질 데이터 (AQI, 미세먼지)
2. **처리**: 각 요소별 가중치를 적용하여 0-100점 스코어 계산
3. **출력**: 점수와 함께 "인생샷 각", "좋은 시간", "방콕 추천" 등의 상태 메시지

**데이터 파이프라인 흐름:**
1. Airflow DAG가 매시간 실행되어 외부 API에서 데이터 수집
2. 수집된 데이터로 뷰티 스코어 계산
3. PostgreSQL에 이력 저장, Redis에 실시간 캐시
4. 날씨 변화 감지 시 AI 이미지 생성 DAG 트리거
5. 계산 결과를 HTML 컴포넌트로 생성하여 Nginx가 서빙

**오류 처리 방식:**
- API 호출 실패 시 Redis 캐시된 이전 데이터 사용
- 캐시도 없을 경우 기본값으로 폴백
- 각 단계별 재시도 로직과 상세한 로깅

## 4. 구현 결과물 (MVP/Prototype)

### 4-1. 실행 화면

**메인 페이지 (http://localhost:8082)**
- 현재 뷰티 스코어와 상태 메시지 표시
- 오늘의 최적 시간대 그래프
- 이번 주 최적 날짜 추천
- 사진 업로드 인터페이스

**Airflow 관리 페이지 (http://localhost:8080)**
- 데이터 파이프라인 실행 상태 모니터링
- 각 태스크별 로그 확인 가능
- 스케줄링 상태 및 오류 알림

### 4-2. 기능 설명

**화면 1 - 실시간 뷰티 스코어**: 현재 날씨 조건을 종합하여 계산된 0-100점 스코어로 사용자가 한눈에 방문 적합성을 판단할 수 있음

**화면 2 - 시간대별 추천**: 오늘 하루 중 가장 좋은 시간대를 그래프로 표시하여 최적의 방문 시간을 계획할 수 있음

**화면 3 - 사진 업로드**: AI가 인경호 풍경 사진인지 자동 분류하여 서비스 품질을 유지하고 사용자 참여를 유도

### 4-3. 동작 여부

**현재 동작하는 부분:**
- ✅ 실시간 뷰티 스코어 계산 및 표시
- ✅ HTMX 기반 자동 업데이트 (10분마다)
- ✅ 이미지 업로드 및 AI 분류
- ✅ PostgreSQL/Redis 데이터 저장

**미완성 또는 제한사항:**
- 🔄 실제 기상청/환경공단 API 연동 (현재 Mock 데이터 사용)
- 🔄 AI 생성 배경 이미지 (Stable Diffusion 연동 필요)
- 🔄 월간 캘린더 예측 기능 (통계 모델 개발 중)

## 5. 서비스와의 연결성 (Real-world Fit)

### 5-1. 전체 서비스 중 해당 기능의 위치

**사용자 흐름:**
1. 사용자가 웹페이지 접속
2. 현재 뷰티 스코어 확인
3. 방문 결정 (높은 점수 시 즉시 출발, 낮은 점수 시 최적 시간 대기)
4. 방문 후 사진 업로드로 서비스 개선에 기여

**전체 서비스에서의 비중:** 뷰티 스코어 계산과 표시가 서비스의 핵심 기능으로 전체 사용자 경험의 80%를 차지합니다.

### 5-2. '문제정의–분석–기획–구현'의 연결

**문제정의**: 인경호 방문 적합성을 사전에 알 수 없는 문제
**분석**: 날씨, 대기질, 시간대가 호수의 아름다움에 미치는 영향 분석
**기획**: 복합적 요소를 하나의 점수로 단순화하는 알고리즘 설계
**구현**: Airflow 기반 실시간 데이터 파이프라인과 정적 파일 서빙 아키텍처로 안정성과 성능 확보

### 5-3. 향후 개선 계획

**Phase 2 계획:**
- 실제 기상청/환경공단 API 연동
- 사용자 업로드 사진 기반 스코어 알고리즘 개선
- Web Push Notification (90점 이상 시 알림)

**Phase 3 계획:**
- 교내 상권 연동 광고 시스템
- 커뮤니티 기능 (사진 공유, 댓글)
- 모바일 앱 개발

---

**파일명**: 기술설명서.md  
**제출일**: 2025년 11월 20일  
**프로젝트**: 인경호 뷰티 스코어 서비스