# ğŸï¸ Ingyeongho Beauty Score - Simplified Architecture

## ğŸ¯ Architecture Overview

This is a **single-page application** with a clean separation of concerns:

- **Nginx**: Serves static HTML files and proxies upload requests
- **FastAPI**: Handles only image upload functionality  
- **Airflow DAGs**: Process all data and generate static HTML components
- **HTMX**: Provides dynamic updates without page refreshes

## ğŸ“‹ 5 Main Endpoints

| Endpoint | Served By | Purpose |
|----------|-----------|---------|
| `GET /` | Nginx | Main page with 3 HTMX components |
| `GET /components/hero.html` | Nginx | Current weather conditions |
| `GET /components/today.html` | Nginx | Today's best time |
| `GET /components/week.html` | Nginx | Week's best day |
| `POST /upload/image` | FastAPI | Image upload with AI validation |

## ğŸ”„ Data Flow

```
Weather APIs â†’ Airflow DAGs â†’ Generate HTML Files â†’ Nginx Serves Them
                                                  â†“
                                          HTMX Auto-Updates Components
```

## ğŸš€ How to Run

1. **Start the services:**
   ```bash
   docker-compose up -d
   ```

2. **Access the application:**
   - Main app: http://localhost:8082
   - Airflow UI: http://localhost:8080 (admin/admin)

3. **Test the endpoints:**
   ```bash
   python test_weather_routes.py
   ```

## ğŸ“ File Structure

```
nginx/html/
â”œâ”€â”€ index.html              # Main page (served by Nginx)
â””â”€â”€ components/
    â”œâ”€â”€ hero.html           # Generated by Airflow
    â”œâ”€â”€ today.html          # Generated by Airflow  
    â””â”€â”€ week.html           # Generated by Airflow

app/
â””â”€â”€ main.py                 # Minimal FastAPI (upload only)

airflow/dags/
â”œâ”€â”€ weather_etl_dag.py      # Generates component HTML files
â””â”€â”€ ai_image_dag.py         # Generates background images
```

## ğŸ”§ Component Generation

### Airflow Worker Setup
Airflow workers can write to nginx/html/components through shared Docker volumes:

```yaml
# In docker-compose.yaml
x-airflow-common:
  volumes:
    - ./nginx/html:/opt/airflow/nginx_html  # Shared volume
```

### DAG Tasks
**Weather ETL DAG** (runs hourly) generates all 3 components:

1. **generate_hero_component**: Creates `hero.html` with current weather
2. **generate_today_component**: Creates `today.html` with best time today  
3. **generate_week_component**: Creates `week.html` with best day this week

### Manual Generation (for testing)
```bash
# Generate components without waiting for Airflow
python trigger_component_generation.py
```

### File Paths in Airflow Workers
- **Write to**: `/opt/airflow/nginx_html/components/`
- **Nginx serves from**: `/usr/share/nginx/html/components/`
- **Local development**: `nginx/html/components/`

## ğŸŒ HTMX Auto-Refresh

Components automatically refresh:
- **Hero**: Every 10 minutes (`600s`)
- **Today**: Every 30 minutes (`1800s`)  
- **Week**: Every 1 hour (`3600s`)

## ğŸ“¤ Image Upload

The only dynamic functionality in FastAPI:
- Validates file size/type
- Uses AI to classify images
- Stores approved images
- Returns HTMX-compatible responses

## ğŸ¨ Benefits

- **Simple**: Only 5 endpoints
- **Fast**: Static files served by Nginx
- **Scalable**: No database queries in web requests
- **Reliable**: Components work even if FastAPI is down
- **Clean**: Clear separation between data processing and serving

## ğŸ” Monitoring

- **Nginx logs**: `/var/log/nginx/`
- **FastAPI logs**: Docker logs for `app` service
- **Airflow logs**: Airflow UI â†’ DAGs â†’ Task logs